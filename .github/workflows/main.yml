# Consolidated CI/CD Pipeline
# This workflow consolidates all testing, coverage, and build tasks
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # Detect changed files to conditionally run tests
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      java: ${{ steps.filter.outputs.java }}
      tests: ${{ steps.filter.outputs.tests }}
      integration: ${{ steps.filter.outputs.integration }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            java:
              - '**/*.java'
              - '**/pom.xml'
            tests:
              - '**/*Test.java'
              - '**/*IT.java'
              - '**/*E2E.java'
            integration:
              - '**/*IT.java'
              - '**/*E2E.java'
              - '**/pom.xml'

  # Unit Tests - Run on all Java versions
  unit-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.java == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [8, 11, 17]
    name: Unit Tests (Java ${{ matrix.java-version }})
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: Run unit tests with coverage
        run: xvfb-run mvn clean test jacoco:report
        continue-on-error: ${{ matrix.java-version != 17 }}
      
      - name: Generate JaCoCo report
        if: matrix.java-version == 17
        run: mvn jacoco:report
      
      - name: Upload coverage reports
        if: matrix.java-version == 17 && always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report-java-${{ matrix.java-version }}
          path: target/site/jacoco/
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-java-${{ matrix.java-version }}
          path: target/surefire-reports/

  # Integration Tests - Only on Java 17 with Docker
  integration-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.integration == 'true'
    runs-on: ubuntu-latest
    name: Integration Tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Run integration tests
        run: xvfb-run mvn verify -DskipITs=false
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
        continue-on-error: true
      
      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failsafe-reports
          path: target/failsafe-reports/

  # Mutation Testing - Only on Java 8
  mutation-testing:
    needs: detect-changes
    if: needs.detect-changes.outputs.tests == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Mutation Testing
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          cache: maven
      
      - name: Run PIT mutation testing
        run: mvn org.pitest:pitest-maven:mutationCoverage
        continue-on-error: true
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
      
      - name: Upload mutation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-reports
          path: target/pit-reports/

  # Coverage Check - Only on Java 17
  coverage-check:
    needs: [unit-tests, detect-changes]
    if: needs.detect-changes.outputs.java == 'true'
    runs-on: ubuntu-latest
    name: Coverage Check
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Check coverage thresholds
        run: mvn jacoco:check
        continue-on-error: true
      
      - name: Upload to Coveralls
        if: github.event_name == 'push'
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: mvn coveralls:report
        continue-on-error: true

  # SonarCloud Analysis
  sonarcloud:
    needs: [unit-tests, coverage-check]
    if: needs.detect-changes.outputs.java == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    name: SonarCloud Analysis
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # Build
  build:
    needs: [unit-tests, integration-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'failure')
    runs-on: ubuntu-latest
    name: Build
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Build project
        run: mvn clean install -DskipITs=true

