# Consolidated CI/CD Pipeline
# This workflow consolidates all testing, coverage, and build tasks
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  # Detect changed files to conditionally run tests
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      java: ${{ steps.filter.outputs.java }}
      tests: ${{ steps.filter.outputs.tests }}
      integration: ${{ steps.filter.outputs.integration }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            java:
              - '**/*.java'
              - '**/pom.xml'
            tests:
              - '**/*Test.java'
              - '**/*IT.java'
              - '**/*E2E.java'
            integration:
              - '**/*IT.java'
              - '**/*E2E.java'
              - '**/pom.xml'
      - name: Debug outputs
        run: |
          echo "java: ${{ steps.filter.outputs.java }}"
          echo "tests: ${{ steps.filter.outputs.tests }}"
          echo "integration: ${{ steps.filter.outputs.integration }}"

  # Unit Tests - Run on all Java versions
  # Always run on push/workflow_dispatch, conditionally on PR based on file changes
  unit-tests:
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'push' || 
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.java == 'true')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [8, 11, 17]
    name: Unit Tests (Java ${{ matrix.java-version }})
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: Install xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Run unit tests with coverage
        run: |
          xvfb-run mvn clean test jacoco:report -U \
            -Dmaven.compiler.source=${{ matrix.java-version }} \
            -Dmaven.compiler.target=${{ matrix.java-version }} \
            -Pui-tests \
            -Dsurefire.excludes="**/*IT.java"
        continue-on-error: ${{ matrix.java-version != 17 }}
      
      - name: Generate JaCoCo report
        if: matrix.java-version == 17
        run: mvn jacoco:report
      
      - name: Upload coverage reports
        if: matrix.java-version == 17 && always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report-java-${{ matrix.java-version }}
          path: target/site/jacoco/
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-java-${{ matrix.java-version }}
          path: target/surefire-reports/

  # Integration Tests - Only on Java 17 with Docker
  # Always run on push/workflow_dispatch, conditionally on PR based on file changes
  integration-tests:
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'push' || 
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.integration == 'true')
    runs-on: ubuntu-latest
    name: Integration Tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Install xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Verify Docker is available
        run: |
          docker --version
          docker info
      
      - name: Run integration tests
        run: xvfb-run -a mvn clean verify -U -DskipITs=false -Dmaven.compiler.source=17 -Dmaven.compiler.target=17
        continue-on-error: true
        env:
          # Ensure Testcontainers can access Docker
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          DOCKER_HOST: unix:///var/run/docker.sock
      
      - name: Display test failures
        if: failure()
        run: |
          echo "=== Integration Test Failures ==="
          if [ -d "target/failsafe-reports" ]; then
            find target/failsafe-reports -name "*.txt" -exec cat {} \;
          fi
      
      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failsafe-reports
          path: target/failsafe-reports/

  # Mutation Testing - On Java 8
  # Run on push/workflow_dispatch, conditionally on PR based on test file changes
  mutation-testing:
    needs: detect-changes
    if: |
      (github.event_name == 'workflow_dispatch' || github.event_name == 'push') ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.tests == 'true')
    runs-on: ubuntu-latest
    name: Mutation Testing
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          cache: maven
      
      - name: Install xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Run PIT mutation testing
        run: xvfb-run -a mvn clean test-compile org.pitest:pitest-maven:mutationCoverage -U -Dmaven.compiler.source=8 -Dmaven.compiler.target=8
        continue-on-error: true
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
      
      - name: Upload mutation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-reports
          path: target/pit-reports/

  # Coverage Check - Only on Java 17
  # Run after unit-tests complete
  coverage-check:
    needs: [unit-tests, detect-changes]
    if: |
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'failure') &&
      (github.event_name == 'workflow_dispatch' || 
       github.event_name == 'push' || 
       (github.event_name == 'pull_request' && needs.detect-changes.outputs.java == 'true'))
    runs-on: ubuntu-latest
    name: Coverage Check
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Install xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Run tests and generate JaCoCo report
        run: |
          xvfb-run mvn clean test jacoco:report -U \
            -Dmaven.compiler.source=17 \
            -Dmaven.compiler.target=17 \
            -Pui-tests \
            -Dsurefire.excludes="**/*IT.java"
        continue-on-error: true
      
      - name: Upload JaCoCo report for SonarCloud
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report-coverage-check
          path: target/site/jacoco/
      
      - name: Upload to Coveralls
        if: github.event_name == 'push'
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: xvfb-run -a mvn coveralls:report -U -Dmaven.compiler.source=17 -Dmaven.compiler.target=17
        continue-on-error: true

  # SonarCloud Analysis
  # Only run on push events (not PRs) after coverage check
  sonarcloud:
    needs: [unit-tests, coverage-check]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (needs.coverage-check.result == 'success' || needs.coverage-check.result == 'failure')
    runs-on: ubuntu-latest
    name: SonarCloud Analysis
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Download JaCoCo report from coverage-check
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report-coverage-check
          path: target/site/jacoco/
        continue-on-error: true
      
      - name: Download JaCoCo report from unit-tests (fallback)
        if: failure()
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report-java-17
          path: target/site/jacoco/
        continue-on-error: true
      
      - name: Run tests and generate JaCoCo report (if not downloaded)
        if: failure()
        run: |
          xvfb-run mvn clean test jacoco:report -U \
            -Dmaven.compiler.source=17 \
            -Dmaven.compiler.target=17 \
            -Pui-tests \
            -Dsurefire.excludes="**/*IT.java"
        continue-on-error: true
      
      - name: Compile code for SonarCloud analysis
        run: |
          xvfb-run -a mvn compile -U -Dmaven.compiler.source=17 -Dmaven.compiler.target=17
        continue-on-error: true
      
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=abdulkader138_personal-expense-tracker
            -Dsonar.organization=abdulkader138
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
            -Dsonar.sources=src/main/java
            -Dsonar.tests=src/test/java
            -Dsonar.java.binaries=target/classes
            -Dsonar.ci.autoconfig.disabled=false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # Build
  build:
    needs: [unit-tests, integration-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'failure')
    runs-on: ubuntu-latest
    name: Build
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: maven
      
      - name: Build project
        run: mvn clean install -U -DskipITs=true -Dmaven.compiler.source=17 -Dmaven.compiler.target=17

